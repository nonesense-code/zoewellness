<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Product List</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
    />
    <script>
      let cart = {};
      let cartCount = 0;

      window.onload = function () {
        const storedCart = localStorage.getItem("cart");
        if (storedCart) {
          cart = JSON.parse(storedCart);
          cartCount = Object.keys(cart).length;
          updateCartCounter();
        }
      };

      function addToCart(product, itemId) {
        const quantityInput = document.getElementById(`quantity-${itemId}`);
        const quantity = parseInt(quantityInput.value) || 1;

        if (!cart[itemId]) {
          cart[itemId] = { name: product, count: quantity };
          cartCount++;
        } else {
          cart[itemId].count += quantity;
        }

        updateCartCounter();
        saveCartToLocalStorage();
        quantityInput.value = 1;
      }

      function updateCartCounter() {
        document.getElementById("cart-count").innerText = cartCount;
      }

      function updateQuantity(itemId, newQuantity) {
        if (cart[itemId]) {
          cart[itemId].count = newQuantity > 0 ? newQuantity : 1;
          saveCartToLocalStorage();
          openCartModal();
        }
      }

      function removeFromCart(itemId) {
        if (cart[itemId]) {
          delete cart[itemId];
          cartCount--;
          updateCartCounter();
          saveCartToLocalStorage();
          openCartModal();
        }
      }

      function saveCartToLocalStorage() {
        localStorage.setItem("cart", JSON.stringify(cart));
      }

      function openCartModal() {
        const modal = document.getElementById("cart-modal");
        const cartItemsList = document.getElementById("cart-items");
        cartItemsList.innerHTML = "";

        if (cartCount === 0) {
          cartItemsList.innerHTML = "<li>No items in the cart.</li>";
        } else {
          for (const [itemId, item] of Object.entries(cart)) {
            cartItemsList.innerHTML += `
            <li class="py-1 flex justify-between items-center">
              ${item.name}
              <input type="number" min="1" value="${item.count}"
                onchange="updateQuantity('${itemId}', this.value)"
                class="w-12 text-center border rounded mx-2" />
              <button onclick="removeFromCart('${itemId}')"
                class="bg-red-500 text-white ml-4 px-2 rounded-md">Remove</button>
            </li>`;
          }
        }
        modal.classList.remove("hidden");
      }

      function closeCartModal() {
        document.getElementById("cart-modal").classList.add("hidden");
      }

      function checkout() {
        const cartDetails = Object.entries(cart).map(([itemId, item]) => ({
          id: itemId,
          count: item.count,
        }));

        const queryString = cartDetails
          .map((item) => `${item.id}=${item.count}`)
          .join("&");

        window.location.href = `/orders/id?${queryString}`;
      }

      function deleteProduct(productId) {
        if (confirm("Are you sure you want to delete this product?")) {
          fetch(`/delete-product/${productId}`, {
            method: "post",
          })
            .then((response) => {
              if (response.ok) {
                document.getElementById(`item-${productId}`).remove();
                alert("Product deleted successfully!");
              } else {
                alert("Error deleting product");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("Error deleting product");
            });
        }
      }

      function toggleEdit(itemId) {
        const editRow = document.getElementById(`edit-row-${itemId}`);
        const saveButton = document.getElementById(`save-button-${itemId}`);
        const editButton = document.getElementById(`edit-button-${itemId}`);

        editRow.classList.toggle("hidden");
        saveButton.classList.toggle("hidden");
        editButton.classList.toggle("hidden");
      }

      function saveEdit(itemId) {
        const updatedName = document.getElementById(
          `edit-name-${itemId}`
        ).value;
        const updatedVolume = document.getElementById(
          `edit-volume-${itemId}`
        ).value;
        const updatedRate = document.getElementById(
          `edit-rate-${itemId}`
        ).value;
        const updatedPV = document.getElementById(`edit-pv-${itemId}`).value;
        const updatedBV = document.getElementById(`edit-bv-${itemId}`).value;

        fetch(`/edit-product/${itemId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            name: updatedName,
            volume: updatedVolume,
            rate: updatedRate,
            pv: updatedPV,
            bv: updatedBV,
          }),
        })
          .then((response) => {
            if (response.ok) {
              alert("Product updated successfully!");
              location.reload();
            } else {
              alert("Error updating product");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error updating product");
          });
      }
    </script>
  </head>

  <body>
    <nav
      class="bg-white shadow-md top-0 z-10 flex items-center justify-center px-4 fixed w-full"
    >
      <div
        class="container mx-auto px-4 py-4 flex justify-between items-center"
      >
        <div>
          <a href="/" class="text-xl font-bold text-blue-500">ZOE</a>
        </div>
        <div>
          <ul class="flex space-x-4">
            <li>
              <a
                href="/"
                class="text-gray-600 text-lg font-bold hover:text-blue-500 cursor-pointer"
                >Home</a
              >
            </li>
            <li>
              <% if (cookieExist) { %>
              <a
                href="/addproducts"
                id="addProducts"
                class="text-gray-600 text-lg font-bold hover:text-blue-500 cursor-pointer"
              >
                Add Products
              </a>
              <% } %>
            </li>

            <li
              class="text-gray-600 text-lg font-bold hover:text-blue-500 cursor-pointer"
              onclick="openCartModal()"
            >
              Cart (<span id="cart-count">0</span>)
            </li>
          </ul>
        </div>
      </div>
      <div>
        <form
          action="/search"
          method="post"
          class="flex gap-2 items-center justify-center"
        >
          <div>
            <input
              type="text"
              name="search_items"
              placeholder="Search..."
              class="w-72 h-auto border-2 border-blue-500 rounded-lg text-black px-2 py-2"
              required
            />
          </div>
          <div class="flex items-center justify-center">
            <button
              type="submit"
              name="submit"
              class="p-2 bg-gray-200 hover:bg-gray-300 rounded-lg"
            >
              <i class="fa-solid fa-magnifying-glass"></i>
              <span class="sr-only">Search</span>
            </button>
          </div>
        </form>
      </div>
    </nav>

    <div class="mt-16">
      <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold text-center mb-4">Product List</h1>

        <table
          id="product-table"
          class="table-auto w-full bg-white shadow-md rounded-lg overflow-hidden"
        >
          <thead>
            <tr
              class="bg-gray-200 text-gray-600 uppercase text-xs leading-normal"
            >
              <th class="py-3 px-2 text-left">S.N</th>
              <th class="py-3 px-2 text-left">Name</th>
              <th class="py-3 px-2 text-left">Volume</th>
              <th class="py-3 px-2 text-left">Rate</th>
              <th class="py-3 px-2 text-left">PV</th>
              <th class="py-3 px-2 text-left">BV</th>
              <% if (cookieExist) { %>
              <th class="py-3 px-2 text-left">Actions</th>
              <% } %>
              <th class="py-3 px-2 text-left">Quantity</th>
              <th class="py-3 px-2 text-left">Add to Cart</th>
            </tr>
          </thead>
          <tbody>
            <% items.forEach((item, index) => { %>
            <tr
              id="item-<%= item._id %>"
              class="border-b border-gray-200 bg-gray-50 hover:bg-gray-100"
            >
              <td class="py-3 px-2"><%= index + 1 %></td>
              <td class="py-3 px-2"><%= item.name %></td>
              <td class="py-3 px-2"><%= item.volume %></td>
              <td class="py-3 px-2"><%= item.rate %></td>
              <td class="py-3 px-2"><%= item.pv %></td>
              <td class="py-3 px-2"><%= item.bv %></td>
              <% if (cookieExist) { %>
              <td class="py-3 px-2 flex gap-2">
                <button
                  id="edit-button-<%= item._id %>"
                  onclick="toggleEdit('<%= item._id %>')"
                  class="bg-blue-500 text-white py-1 px-3 rounded-md"
                >
                  Edit
                </button>
                <button
                  onclick="deleteProduct('<%= item._id %>')"
                  class="bg-red-500 text-white py-1 px-3 rounded-md"
                >
                  Delete
                </button>
                <button
                  id="save-button-<%= item._id %>"
                  onclick="saveEdit('<%= item._id %>')"
                  class="bg-green-500 text-white py-1 px-3 rounded-md hidden"
                >
                  Save
                </button>
              </td>
              <% } %>
              <td class="py-3 px-2">
                <input
                  id="quantity-<%= item._id %>"
                  type="number"
                  min="1"
                  value="1"
                  class="border w-16 rounded-lg p-1 text-center"
                />
              </td>
              <td class="py-3 px-2">
                <button
                  onclick="addToCart('<%= item.name %>', '<%= item._id %>')"
                  class="bg-blue-500 text-white py-1 px-3 rounded-md"
                >
                  Add
                </button>
              </td>
            </tr>
            <tr id="edit-row-<%= item._id %>" class="hidden">
              <td></td>
              <td>
                <input
                  id="edit-name-<%= item._id %>"
                  type="text"
                  value="<%= item.name %>"
                  class="border w-full p-1 rounded-md"
                />
              </td>
              <td>
                <input
                  id="edit-volume-<%= item._id %>"
                  type="text"
                  value="<%= item.volume %>"
                  class="border w-full p-1 rounded-md"
                />
              </td>
              <td>
                <input
                  id="edit-rate-<%= item._id %>"
                  type="text"
                  value="<%= item.rate %>"
                  class="border w-full p-1 rounded-md"
                />
              </td>
              <td>
                <input
                  id="edit-pv-<%= item._id %>"
                  type="text"
                  value="<%= item.pv %>"
                  class="border w-full p-1 rounded-md"
                />
              </td>
              <td>
                <input
                  id="edit-bv-<%= item._id %>"
                  type="text"
                  value="<%= item.bv %>"
                  class="border w-full p-1 rounded-md"
                />
              </td>
            </tr>
            <% }); %>
          </tbody>
        </table>
      </div>

      <div
        id="cart-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center"
      >
        <div class="bg-white p-6 rounded-lg w-1/2">
          <h2 class="text-lg font-bold mb-4">Your Cart</h2>
          <ul id="cart-items" class="mb-4"></ul>
          <div class="flex justify-between">
            <button
              onclick="checkout()"
              class="bg-green-500 text-white py-2 px-4 rounded-md"
            >
              Checkout
            </button>
            <button
              onclick="closeCartModal()"
              class="bg-red-500 text-white py-2 px-4 rounded-md"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
</html>
